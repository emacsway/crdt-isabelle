# Getting started

In this directory we provide (non-anonymised) supplementary material for the
OOPSLA/SPLASH 2017 submissions "Verifying Strong Eventual Consistency in
Distributed Systems" by Gomes, Kleppmann, Mulligan, and Beresford.

The directory consists of three components:

  1. An annotated auto-generated PDF of all of our Isabelle definitions and theorems.
  2. Our Isabelle theory files, containing our definitions and theorems which can be
     checked by Isabelle2016-1.
  3. An OCaml extraction of our three CRDTs, plus a simple asynchronous network, built
     atop TCP, of an arbitrary number of communicating nodes using the OCaml
     extraction of our counter CRDT to demonstrate that our definitions are usable in
     practice.

To verify that our proofs are correct follow these instructions:

Download Isabelle2016-1 from the Isabelle homepage:

    https://isabelle.in.tum.de/

(Assuming Linux) extract the .tar.gz file by

    tar xzf file.tar.gz

Run Isabelle for the first time by running

    $Isabelle2016-1-DIRECTORY/Isabelle2016-1.run

This will open a jEdit window after which Isabelle will begin building various
"heaps".  Once Complex_Main has been built, which should take around 15 minutes on
a moderately fast machine, open one of RGA.thy, ORSet.thy, or Counter.thy.

Isabelle will ask whether all theory dependencies should be loaded.  Click "yes".

After a few minutes, Isabelle will start to process the file that you have opened,
once all dependencies have been processed.  This is indicated by a "purple wave"
flowing down the theory file.  Scroll to the bottom of the file, and the entirety
of the theory should be processed.  Note that purple indicates Isabelle is processing
the definition or theorem (some steps may take a while), whereas red indicates
processing has failed with an error.  Isabelle should not show any red when processing
our development.

Alternatively, if you do not wish to install Isabelle to check our proofs, you can
read through the annotated_proofs.pdf document instead.  This is automatically
generated by Isabelle from our theory files, and contains passages from our paper
inserted as comments, so you can orient yourself within our development.

# Evaluation

A description of the Isabelle proof contained within the theory files in our artefact
submission forms the largest component of our paper (Sections 4--7).

To check that our theorems are "real" theorems: press CTRL+F to open search.  Type
sorry into the search box, click the "All buffers" radio button, and click "Search".
No instances of "sorry" (i.e. an admitted theorem, without proof) should be present,
indicating that we rely on no axioms other than those described in our paper.

One may also use the included "annotated-proofs.pdf" file, automatically generated
from our Isabelle proofs, to see that our Isabelle code and Sections 4--7 of our
paper are in synchrony.

Next, we claimed that our CRDT definitions are "executable" in our paper (Section 9).
To check that this is the case, one can examine the OCaml source code that Isabelle's
code generation mechanism produces, and also check that this process does not fail.
Within our three CRDT implementation theories (ORSet.thy, RGA.thy, and Counter.thy)
is an Isabelle command that starts with "export_code".  This is an instruction to
Isabelle to generate OCaml code from the definitions listed after the command.  Every
time the theory file is processed, this code generation mechanism will extract code
and write to the specified file.  To check that this is happening correctly, simply
delete the existing OCaml files that we supplied in our artefact submission and
recheck the relevant theories, causing Isabelle to create new OCaml files as a
side-effect.

Lastly, to run our network experiment (assuming OCaml's OPAM is installed) mentioned
briefly in Section 9:

Ensure Jane Street Core and the Async libraries are installed:

  opam install core async

Run the Makefile in the ocaml/ directory provided in this distribution:

  make

Run the test.sh shell script in ocaml/ to create a network of four communicating
nodes.  Edit the contents of test.sh to change the size of the network.

Once running, the network should generate increment/decrement messages randomly,
with nodes generating messages potentially concurrently.

To kill the network, run

  pkill -9 network

Nodes can be run on remote machines by editing the contents of test.sh also (i.e.
change localhost to some other address).  This network experiment uses the OCaml
code generated from the Counter.thy theory file.  If this is deleted, simply
reprocess Counter.thy with Isabelle to reproduce, as described above.